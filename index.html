<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Coloring Book App</title>
  <style>
    html, body { margin:0; padding:0; height:100%; touch-action:none; font-family:'Comic Sans MS'; background:#fff6e0; }
    #home,#library,#pageSelect,#drawing { display:none; flex-direction:column; align-items:center; justify-content:center; height:100%; overflow:hidden; }
    #home{display:flex; background:linear-gradient(to bottom right,#ffdee9,#b5fffc);}
    .home-btn { margin:20px; border:none; background:none; cursor:pointer; }
    .home-btn img{width:180px;}
    #pageSelect, #library { display:none; flex-wrap:wrap; justify-content:center; align-content:flex-start; overflow-y:auto; width:100%; padding:10px; box-sizing:border-box; }
    #pageSelect img, #library img { width:150px; margin:10px; border:3px solid #f06292; border-radius:10px; cursor:pointer; }
    #top-bar,#bottom-bar { display:flex; flex-wrap:nowrap; justify-content:center; gap:10px; background:#ffe0f0; padding:10px; box-sizing:border-box; }
    button, .tool, .color { padding:10px 14px; font-size:18px; border:none; border-radius:10px; cursor:pointer; background:#f06292; color:white; box-shadow:2px 2px 6px rgba(0,0,0,0.2); }
    .tool, .color { width:38px; height:38px; display:flex; align-items:center; justify-content:center; }
    .color { border:2px solid #f06292; padding:0; flex:0 0 auto; }
    .active { border:3px solid #ff4081 !important; }
    #canvas-container { flex:1; position:relative; background:#fff; overflow:hidden; display:flex; justify-content:center; align-items:center; }
    canvas { touch-action:none; border-radius:10px; transform-origin:0 0; transition:transform .1s; cursor:grab; }
    #bottom-bar { overflow-x:auto; scrollbar-color:#f06292 #ffe0f0; }
    #bottom-bar::-webkit-scrollbar { height:8px; }
    #bottom-bar::-webkit-scrollbar-track { background:#ffe0f0; border-radius:4px; }
    #bottom-bar::-webkit-scrollbar-thumb { background:#f06292; border-radius:4px; }
  </style>
</head>
<body>
  <div id="home">
    <button class="home-btn" onclick="showLibrary()"><img src="https://img.icons8.com/clouds/200/000000/opened-folder.png"/></button>
    <button class="home-btn" onclick="showPageSelect()"><img src="https://img.icons8.com/clouds/200/000000/paint-palette.png"/></button>
  </div>

  <div id="library"></div>
  <div id="pageSelect"></div>

  <div id="drawing">
    <div id="top-bar">
      <button onclick="undo()">Undo</button>
      <button onclick="redo()">Redo</button>
      <button onclick="save()">Save</button>
      <button onclick="download()">Download</button>
      <button onclick="clearCanvas()">Clear</button>
    </div>
    <div id="canvas-container">
      <canvas id="drawCanvas" width="800" height="800"></canvas>
    </div>
    <div id="bottom-bar">
      <div class="tool" data-tool="bucket">ðŸª£</div>
      <div class="tool" data-tool="eraser">ðŸ§½</div>
      <!-- More colors added dynamically -->
    </div>
  </div>

  <audio id="clickSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_059f6bff69.mp3?filename=click-124467.mp3"></audio>

  <script>
  // -- Globals --
  const canvas = document.getElementById('drawCanvas');
  const ctx = canvas.getContext('2d');
  const img = new Image(); img.crossOrigin = 'anonymous';
  const clickSound = document.getElementById('clickSound');
  let tool = 'bucket', color = 'black';
  let scale = 1, tx = 0, ty = 0;
  let isDragging = false, isPanning = false, startDrag = null, panStart = null, lastDist = null;
  const drawings = [ /* your URLs stay here */ ];
  const savedImages = [], undoStack = [], redoStack = [];

  // -- UI Helpers --
  function playClick() { clickSound.currentTime = 0; clickSound.play(); }
  function hideAll() { ['home','library','pageSelect','drawing'].forEach(id => document.getElementById(id).style.display='none'); }
  function showHome(){ hideAll(); document.getElementById('home').style.display='flex'; }
  function showLibrary(){
    hideAll();
    const lib = document.getElementById('library');
    lib.style.display='flex';
    lib.innerHTML='<h2>Saved</h2>';
    savedImages.forEach(src=>{
      let im = document.createElement('img');
      im.src = src;
      lib.appendChild(im);
    });
    let b = document.createElement('button');
    b.textContent='â¬… Back'; b.onclick=showHome;
    lib.appendChild(b);
  }
  function showPageSelect(){
    hideAll();
    const ps = document.getElementById('pageSelect');
    ps.style.display='flex';
    ps.innerHTML='<h2>Pick a Page</h2>';
    drawings.forEach((s,i)=>{
      let t = document.createElement('img');
      t.src = s;
      t.onclick = () => loadPage(i);
      ps.appendChild(t);
    });
    let b = document.createElement('button');
    b.textContent='â¬… Back'; b.onclick=showHome;
    ps.appendChild(b);
  }
  function loadPage(i){
    hideAll();
    document.getElementById('drawing').style.display='flex';
    img.onload = () => { resetTransform(); drawImageScaled(); pushUndo(); };
    img.src = drawings[i] + '?v=' + Date.now();
  }

  // -- Tool & Color Buttons --
  document.querySelectorAll('.tool').forEach(el=>{
    el.onclick = ()=>{
      playClick();
      tool = el.dataset.tool;
      updateUI();
    };
  });
  const colorList = ['black','gray','red','orange','yellow','green','blue','purple','pink','peach','tan','brown','white','cyan','magenta','navy','#f4c2c2'];
  colorList.forEach(c=>{
    let d = document.createElement('div');
    d.className='color';
    d.style.background = c;
    d.onclick = ()=>{ playClick(); color = c; updateUI(); };
    document.getElementById('bottom-bar').appendChild(d);
  });

  function updateUI(){
    document.querySelectorAll('.tool').forEach(el=>{
      el.classList.toggle('active', el.dataset.tool === tool);
    });
    document.querySelectorAll('.color').forEach(el=>{
      el.classList.toggle('active', el.style.background === color);
    });
  }

  // -- Canvas Mouse / Touch Handling --
  canvas.addEventListener('mousedown', e => {
    if (e.button === 0) { // draw
      isDragging = true;
      startDrag = {x:e.clientX, y:e.clientY};
    } else if (e.button === 1) { // pan
      isPanning = true;
      panStart = {x:e.clientX, y:e.clientY};
      canvas.style.cursor = 'grabbing';
    }
  });
  document.addEventListener('mousemove', e => {
    if (isDragging) paintAt(e);
    if (isPanning) {
      tx += e.clientX - panStart.x;
      ty += e.clientY - panStart.y;
      panStart = {x:e.clientX, y:e.clientY};
      applyTransform();
    }
  });
  document.addEventListener('mouseup', e => {
    isDragging = false;
    if (isPanning) {
      isPanning = false;
      canvas.style.cursor = 'grab';
    }
  });
  canvas.addEventListener('click', e => paintAt(e));
  canvas.addEventListener('touchstart', e => paintAt(e.touches[0]));
  canvas.addEventListener('touchmove', e => pinchZoom(e), { passive:false });
  canvas.addEventListener('touchend', () => lastDist = null);

  function pinchZoom(e){
    if (e.touches.length === 2) {
      e.preventDefault();
      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      const dist = Math.hypot(dx,dy);
      if (lastDist) {
        scale *= dist / lastDist;
        scale = Math.min(3, Math.max(0.3, scale));
        applyTransform();
      }
      lastDist = dist;
    }
  }

  function applyTransform(){
    canvas.style.transform = `translate(${tx}px,${ty}px) scale(${scale})`;
  }

  function getXY(e){
    const r = canvas.getBoundingClientRect();
    const x = (e.clientX - r.left - tx)/scale;
    const y = (e.clientY - r.top - ty)/scale;
    return { x: Math.floor(x), y: Math.floor(y) };
  }

  function paintAt(e){
    if (!img.src) return;
    const {x,y} = getXY(e);
    if (tool === 'bucket') {
      playClick();
      let data = ctx.getImageData(0,0,canvas.width,canvas.height);
      floodfill(data.data, x,y, hexToRGBA(color), 25, data.width, data.height);
      ctx.putImageData(data, 0,0);
      pushUndo();
    } else {
      playClick();
      ctx.globalCompositeOperation = 'destination-out';
      ctx.beginPath();
      ctx.arc(x,y,10,0,2*Math.PI);
      ctx.fill();
      ctx.globalCompositeOperation = 'source-over';
      pushUndo();
    }
  }

  // -- Floodfill Algorithm --
  function floodfill(data, sx, sy, fill, tol, w, h){
    const baseIdx = (sy*w + sx)*4;
    const base = data.slice(baseIdx, baseIdx+4);
    const match = px => {
      for (let i=0; i<4; i++){ if (Math.abs(px[i]-base[i]) > tol) return false; }
      return true;
    };
    const stack = [{x:sx,y:sy}];
    const visited = new Uint8Array(w*h);
    while (stack.length){
      const p = stack.pop();
      if (p.x<0||p.x>=w||p.y<0||p.y>=h) continue;
      const idx = (p.y*w + p.x)*4;
      if (visited[p.y*w + p.x]) continue;
      if (!match(data.slice(idx, idx+4))) continue;
      visited[p.y*w + p.x] = 1;
      data[idx]=fill.r; data[idx+1]=fill.g; data[idx+2]=fill.b; data[idx+3]=fill.a;
      stack.push({x:p.x+1,y:p.y},{x:p.x-1,y:p.y},{x:p.x,y:p.y+1},{x:p.x,y:p.y-1});
    }
  }

  function hexToRGBA(hex){
    const tmp = document.createElement('div');
    tmp.style.color = hex;
    document.body.appendChild(tmp);
    const [r,g,b] = getComputedStyle(tmp).color.match(/\d+/g).map(Number);
    document.body.removeChild(tmp);
    return {r,g,b,a:255};
  }

  // -- Draw Helpers --
  function resetTransform(){ scale=1; tx=ty=0; applyTransform(); }
  function drawImageScaled(){
    const cw=canvas.width, ch=canvas.height;
    const iw=img.width, ih=img.height;
    const ratio=Math.min(cw/iw,ch/ih);
    ctx.clearRect(0,0,cw,ch);
    ctx.drawImage(img,0,0,iw,ih, (cw-iw*ratio)/2,(ch-ih*ratio)/2, iw*ratio,ih*ratio);
  }

  // -- Undo/Redo --
  function pushUndo(){
    undoStack.push(canvas.toDataURL());
    if (undoStack.length>30) undoStack.shift();
    redoStack.length=0;
  }
  function undo(){
    if (undoStack.length<2) return;
    redoStack.push(undoStack.pop());
    restore(undoStack[undoStack.length-1]);
  }
  function redo(){
    if (!redoStack.length) return;
    const d = redoStack.pop();
    undoStack.push(d);
    restore(d);
  }
  function restore(src){
    const i = new Image();
    i.onload = () => { resetTransform(); ctx.drawImage(i,0,0); };
    i.src = src;
  }

  // -- Save/Download/Clear --
  function save(){ savedImages.push(canvas.toDataURL()); alert('Saved!'); }
  function download(){ const a = document.createElement('a'); a.href=canvas.toDataURL(); a.download='coloring.png'; a.click(); }
  function clearCanvas(){ drawImageScaled(); pushUndo(); }

  // -- Start --
  showHome();
  </script>
</body>
</html>
