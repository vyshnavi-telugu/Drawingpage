<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Coloring Book App</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      font-family: sans-serif;
      height: 100%; width: 100%;
      overflow: hidden;
    }
    body { display: flex; flex-direction: column; }

    #home, #library, #pageSelect, #drawing {
      display: none;
      flex: 1; flex-direction: column;
      align-items: center; justify-content: center;
    }

    #home {
      background-color: #f5f5f5;
      background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/d/d1/Rangoli_Design.jpg/800px-Rangoli_Design.jpg') no-repeat center center;
      background-size: cover;
    }

    .home-btn {
      margin: 20px; border: none; background: none;
      cursor: pointer; display: flex;
      flex-direction: column; align-items: center;
    }
    .home-btn img {
      width: 200px; height: auto;
    }
    .home-label {
      margin-top: 8px; font-size: 18px;
      font-weight: bold; color: #fff;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
    }

    #pageSelect img, #library img {
      width: 150px; margin: 10px;
      border: 2px solid #333; cursor: pointer;
    }

    #top-bar {
      display: flex; justify-content: space-around;
      align-items: center; width: 100%;
      background: #eee; padding: 8px;
      box-sizing: border-box;
    }
    #bottom-bar {
      position: absolute;
      bottom: 0; left: 0;
      width: 100%; background: #eee;
      padding: 10px; box-sizing: border-box;
      display: flex; justify-content: center;
      flex-wrap: wrap; z-index: 10;
    }
    .tool, .color {
      margin: 4px; padding: 6px;
      border: 1px solid #333; border-radius: 4px;
      font-size: 20px; cursor: pointer;
    }
    .color { width: 28px; height: 28px; }

    canvas {
      border: none;
      touch-action: none;
      user-select: none;
      width: 100vw;
      height: calc(100vh - 100px);
      margin-bottom: 60px;
      display: block;
    }
    .active { border: 2px solid red !important; }

    /* Button styles */
    #undoBtn, #redoBtn { background: skyblue; color: black; }
    #saveBtn { background: green; color: black; }
    #deleteBtn { background: red; color: black; }
    #downloadBtn { background: yellow; color: black; }
  </style>
</head>
<body>

<div id="home">
  <button class="home-btn" onclick="showLibrary()">
    <img src="https://img.icons8.com/clouds/200/000000/opened-folder.png" alt="Library" />
    <div class="home-label">Library</div>
  </button>
  <button class="home-btn" onclick="showPageSelect()">
    <img src="https://img.icons8.com/clouds/200/paint-palette.png" alt="Coloring Book" />
    <div class="home-label">Coloring Book</div>
  </button>
</div>

<div id="library"></div>
<div id="pageSelect"></div>

<div id="drawing">
  <div id="top-bar">
    <button id="undoBtn">Undo</button>
    <button id="redoBtn">Redo</button>
    <button id="saveBtn">Save</button>
    <button id="deleteBtn">Delete</button>
    <button id="downloadBtn">Download</button>
  </div>
  <canvas id="drawCanvas"></canvas>
  <div id="bottom-bar"></div>
</div>

<script>
const drawings = [
  'https://i.postimg.cc/TPZTn08W/0f00c43f3775ba5fcce443f4885aa56e.jpg',
  'https://i.postimg.cc/Bv8q8yz0/36-girl-with-butterfly-wings-to-color.jpg',
  'https://i.postimg.cc/pLsT5KXD/6331b296558cf1f8f7fd87cc9154f432.jpg',
    'https://i.postimg.cc/2yYmK5Sk/7113dc553901fe5719b2c9e221449e28.jpg',
    'https://i.postimg.cc/MKxKs9n7/adorable-fun-kids-coloring-page-delight-freepik-908673-3027.jpg',
    'https://i.postimg.cc/jS1TrcSk/Barbie-10.jpg',
    'https://i.postimg.cc/FsDmTN5v/Barbie-24.jpg',
    'https://i.postimg.cc/j2YdYXZr/Barbie-27.jpg',
  'https://i.postimg.cc/cJ6JR6rP/bc2884b1a90b6d9db42580113054c40b.jpg'
];
const savedImages = [];
const canvas = document.getElementById('drawCanvas');
const ctx = canvas.getContext('2d');
const img = new Image();
img.crossOrigin = 'anonymous';

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight - document.getElementById('top-bar').offsetHeight - document.getElementById('bottom-bar').offsetHeight;
  redraw();
}
window.addEventListener('resize', resizeCanvas);

let tool = 'bucket', color = 'black';
let scale = 1, pan = { x:0, y:0 };
let lastTouches = [];
const undoStack = [], redoStack = [];
let baseImageLoaded = false;
let imageInitial = null;

document.getElementById('undoBtn').onclick = undo;
document.getElementById('redoBtn').onclick = redo;
document.getElementById('saveBtn').onclick = save;
document.getElementById('deleteBtn').onclick = () => { if(baseImageLoaded) { resetDrawing(); pushUndo(); } };
document.getElementById('downloadBtn').onclick = () => {
  const a = document.createElement('a');
  a.href = canvas.toDataURL('image/png');
  a.download = 'coloring.png';
  a.click();
};

function showHome() { hideAll(); document.getElementById('home').style.display = 'flex'; }
function showLibrary() {
  hideAll();
  const lib = document.getElementById('library');
  lib.style.display='flex'; lib.style.flexWrap='wrap';
  lib.innerHTML='<h2>Saved Images</h2>';
  savedImages.forEach(src => { const i = document.createElement('img'); i.src=src; lib.appendChild(i); });
  const b = document.createElement('button'); b.textContent='⬅ Back'; b.onclick=showHome;
  lib.appendChild(b);
}
function showPageSelect() {
  hideAll();
  const ps = document.getElementById('pageSelect');
  ps.style.display='flex'; ps.style.flexWrap='wrap';
  ps.innerHTML='<h2>Select a Drawing</h2>';
  drawings.forEach((src,i) => {
    const iElem = document.createElement('img');
    iElem.src=src;
    iElem.onclick = () => loadPage(i);
    ps.appendChild(iElem);
  });
  const b = document.createElement('button'); b.textContent='⬅ Back'; b.onclick=showHome;
  ps.appendChild(b);
}
function hideAll() {
  ['home','library','pageSelect','drawing'].forEach(id => document.getElementById(id).style.display='none');
}
function loadPage(i) {
  hideAll(); document.getElementById('drawing').style.display='flex';
  img.onload = () => { baseImageLoaded=true; pan={x:0,y:0}; scale=1; resizeCanvas(); resetDrawing(); pushUndo(); };
  img.src = drawings[i]+'?v='+Date.now();
}
function resetDrawing() {
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  redraw();
}
function redraw() {
  if(!baseImageLoaded) return;
  ctx.setTransform(scale,0,0,scale,pan.x,pan.y);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img, 0, 0, canvas.width/scale, canvas.height/scale);
}

const bar = document.getElementById('bottom-bar');
const palette = ['black','gray','red','orange','yellow','green','blue','purple','pink','brown','white','cyan','magenta','lime','gold','navy',
                  '#ffe0bd','#ffcd94','#eac086','#ffad60','#ffe4c4'];
palette.forEach(c => {
  const d = document.createElement('div');
  d.className = 'color';
  d.style.background = c;
  d.onclick = () => { color=c; updateUI(); };
  bar.appendChild(d);
});
function updateUI() {
  document.querySelectorAll('.color').forEach(el => el.classList.toggle('active', el.style.background===color));
}

// Floodfill
function hexToRGBA(hex) {
  const t = document.createElement('div');
  t.style.color = hex;
  document.body.appendChild(t);
  const [r,g,b] = getComputedStyle(t).color.match(/\d+/g).map(Number);
  document.body.removeChild(t);
  return {r,g,b,a:255};
}
function floodfill(data, sx, sy, fill, tol, w, h) {
  const base = data.slice((sy*w+sx)*4, (sy*w+sx)*4+4);
  const diff = (p,q) => Math.abs(p[0]-q[0])+Math.abs(p[1]-q[1])+Math.abs(p[2]-q[2])+Math.abs(p[3]-q[3]);
  const match = px => diff(px,base)<tol;
  const stk=[{x:sx,y:sy}], vis=new Uint8Array(w*h);
  while(stk.length) {
    const {x,y} = stk.pop();
    if(x<0||y<0||x>=w||y>=h) continue;
    const idx = y*w+x;
    if(vis[idx]) continue;
    vis[idx]=1;
    const i = idx*4;
    const px = data.slice(i,i+4);
    if(!match(px)) continue;
    data[i]=fill.r; data[i+1]=fill.g; data[i+2]=fill.b; data[i+3]=fill.a;
    stk.push({x:x+1,y},{x:x-1,y},{x,y:y+1},{x,y:y-1});
  }
}

// Touch handlers
canvas.addEventListener('touchstart', e => { lastTouches = Array.from(e.touches); });
canvas.addEventListener('touchmove', e => {
  e.preventDefault();
  const t = e.touches;
  if(t.length === 2 && baseImageLoaded) {
    const a = t[0], b = t[1];
    const midX = (a.pageX + b.pageX)/2, midY = (a.pageY + b.pageY)/2;
    if(lastTouches.length === 2) {
      const dCur = Math.hypot(b.pageX-a.pageX, b.pageY-a.pageY);
      const dLast = Math.hypot(lastTouches[1].pageX-lastTouches[0].pageX, lastTouches[1].pageY-lastTouches[0].pageY);
      const deltaS = dCur/dLast;
      scale *= deltaS;
      const panSpeed = 0.3;
      pan.x += (midX - (lastTouches[0].pageX+lastTouches[1].pageX)/2)*panSpeed;
      pan.y += (midY - (lastTouches[0].pageY+lastTouches[1].pageY)/2)*panSpeed;
    }
    lastTouches = Array.from(e.touches);
    redraw();
  } else if(t.length === 1 && lastTouches.length === 1 && baseImageLoaded) {
    const dx = (t[0].pageX - lastTouches[0].pageX)*0.3;
    const dy = (t[0].pageY - lastTouches[0].pageY)*0.3;
    pan.x += dx; pan.y += dy;
    lastTouches = Array.from(e.touches);
    redraw();
  }
}, { passive: false });

canvas.addEventListener('touchend', e => {
  if(baseImageLoaded && lastTouches.length === 1 && tool==='bucket') {
    const rect = canvas.getBoundingClientRect();
    const x = (lastTouches[0].pageX - rect.left - pan.x)/scale;
    const y = (lastTouches[0].pageY - rect.top - pan.y)/scale;
    const imgd = ctx.getImageData(0,0,canvas.width,canvas.height);
    floodfill(imgd.data, Math.floor(x), Math.floor(y), hexToRGBA(color), 60, imgd.width, imgd.height);
    ctx.putImageData(imgd,0,0);
    pushUndo();
  }
  lastTouches = [];
}, { passive: true });

// Undo/Redo/Save
function pushUndo(){
  undoStack.push(canvas.toDataURL());
  if(undoStack.length>50) undoStack.shift();
  redoStack.length = 0;
}
function undo(){
  if(undoStack.length < 2) return;
  redoStack.push(undoStack.pop());
  restore(undoStack[undoStack.length-1]);
}
function redo(){
  if(!redoStack.length) return;
  const d = redoStack.pop();
  undoStack.push(d);
  restore(d);
}
function restore(src){
  const i = new Image();
  i.onload = () => { resetDrawing(); pushUndo(); };
  i.src = src;
}
function save(){
  savedImages.push(canvas.toDataURL());
  alert('Saved to library!');
}

// Init
resizeCanvas();
showHome();
</script>

</body>
</html>
