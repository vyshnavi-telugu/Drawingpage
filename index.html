<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Polished Coloring App</title>
<style>
html,body{margin:0;padding:0;height:100%;overflow:hidden;touch-action:none;font-family:'Comic Sans MS';background:#fff6e0}
.home-btn{display:flex;flex-direction:column;align-items:center;margin:0 20px;cursor:pointer}
.home-btn img{width:180px}
.home-btn span{margin-top:10px;font-size:1.2rem;font-weight:bold;color:#f06292}
#home,#library,#pageSelect,#drawing{display:none;flex-direction:column;width:100%;height:100%}
#home{display:flex;justify-content:center;align-items:center;background:linear-gradient(to bottom right,#ffdee9,#b5fffc)}
#library h2,#pageSelect h2{margin:10px;font-size:1.5rem;font-weight:bold;color:#f06292}
#library,#pageSelect{display:flex;flex-direction:column;overflow-y:auto;align-items:center;padding:0}
#pageSelect img,#library img{width:150px;margin:10px;border:3px solid #f06292;border-radius:10px;cursor:pointer}
#top-bar{display:flex;gap:5px;padding:8px;background:#ffe0f0;overflow-x:auto}
#canvas-container{flex:1;position:relative;overflow:hidden;background:#fff}
canvas{display:block;touch-action:none;border-radius:10px}
#bottom-bar{display:flex;gap:5px;overflow-x:auto;background:#ffe0f0;padding:8px;border-top:2px solid #ccc;box-shadow:inset 0 5px 5px -5px rgba(0,0,0,0.3)}
button,.tool,.color{padding:6px;font-size:16px;border:none;border-radius:8px;cursor:pointer;background:#f06292;color:white;box-shadow:2px 2px 5px rgba(0,0,0,0.2);transition:transform .1s;flex-shrink:0}
button:active,.tool:active,.color:active{transform:scale(0.95)}
.tool,.color{width:36px;height:36px;display:flex;align-items:center;justify-content:center}
.color{border:3px solid #333}
.active{border:3px solid #ff4081!important}
</style>
</head>
<body>
<div id="home">
  <div class="home-btn" onclick="navigate('library')">
    <img src="https://img.icons8.com/clouds/200/000000/opened-folder.png"/><span>My Album</span>
  </div>
  <div class="home-btn" onclick="navigate('pageSelect')">
    <img src="https://img.icons8.com/clouds/200/000000/paint-palette.png"/><span>Colouring Book</span>
  </div>
</div>

<div id="library"><h2>My Album</h2><div><button onclick="navigate('home')">‚¨Ö Back</button></div></div>
<div id="pageSelect"><h2>Colouring Book</h2><div><button onclick="navigate('home')">‚¨Ö Back</button></div></div>

<div id="drawing" style="display:flex;flex-direction:column;height:100%">
  <div id="top-bar">
    <button onclick="undo()">‚éå</button><button onclick="redo()">‚Üª</button>
    <button onclick="save()">üíæ</button><button onclick="download()">‚¨á</button>
    <button onclick="clearCanvas()">üóë</button><button onclick="navigate(prevScreen)">üè†</button>
  </div>
  <div id="canvas-container"><canvas id="canvas"></canvas></div>
  <div id="bottom-bar"></div>
</div>

<audio id="clickSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_059f6bff69.mp3?filename=click-124467.mp3"></audio>

<script>
const STORAGE_KEY='myColorLib',
      canvas=document.getElementById('canvas'),
      ctx=canvas.getContext('2d'),
      img=new Image(), clickSound=document.getElementById('clickSound');

let saved=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'),
    tool='bucket', color='black', scale=1, tx=0, ty=0,
    isDrag=false, start=null, lastDist=null,
    undoStack=[], redoStack=[],
    prevScreen='home', currentScreen='home';

const colors=[
  'black','darkgray','red','orange','yellow','lime','green','teal','blue','navy',
  'purple','magenta','hotpink','peachpuff','tan','saddlebrown','white','cyan','olive',
  'maroon','#8B0000','#00CED1','#ADFF2F','#FF1493','#FF4500','#2E8B57'
];
const drawings=[
  'https://i.postimg.cc/TPZTn08W/0f00c43f3775ba5fcce443f4885aa56e.jpg',
  'https://i.postimg.cc/JnZMxXmY/bunny-carrot-coloring-page-600nw-2414476443.jpg',
  'https://i.postimg.cc/Bv8q8yz0/36-girl-with-butterfly-wings-to-color.jpg',
  'https://i.postimg.cc/TPZTn08W/0f00c43f3775ba5fcce443f4885aa56e.jpg',
  'https://i.postimg.cc/JnZMxXmY/bunny-carrot-coloring-page-600nw-2414476443.jpg',
  'https://i.postimg.cc/Bv8q8yz0/36-girl-with-butterfly-wings-to-color.jpg',
  'https://i.postimg.cc/Bv8q8yz0/36-girl-with-butterfly-wings-to-color.jpg',
  'https://i.postimg.cc/pLsT5KXD/6331b296558cf1f8f7fd87cc9154f432.jpg',
  'https://i.postimg.cc/2yYmK5Sk/7113dc553901fe5719b2c9e221449e28.jpg',
  'https://i.postimg.cc/MKxKs9n7/adorable-fun-kids-coloring-page-delight-freepik-908673-3027.jpg',
  'https://i.postimg.cc/MKxKs9n7/adorable-fun-kids-coloring-page-delight-freepik-908673-3027.jpg',
  'https://i.postimg.cc/jS1TrcSk/Barbie-10.jpg',
  'https://i.postimg.cc/FsDmTN5v/Barbie-24.jpg',
  'https://i.postimg.cc/FsDmTN5v/Barbie-24.jpg',
  'https://i.postimg.cc/j2YdYXZr/Barbie-27.jpg',
  'https://i.postimg.cc/tTxCcfd5/Barbie-6.jpg'
];

(function init(){
  const bottom=document.getElementById('bottom-bar');
  colors.forEach(c=>{
    const d=document.createElement('div');
    d.className='color'; d.style.background=c;
    d.onclick=() => { tool='bucket'; color=c; updateUI(); clickSound.play(); vibrate(30); };
    bottom.appendChild(d);
  });
  ['bucket','eraser'].forEach(n=>{
    const t=document.createElement('div');
    t.className='tool'; t.dataset.tool=n;
    t.textContent=n==='bucket'?'ü™£':'üßΩ';
    t.onclick=() => { tool=n; updateUI(); clickSound.play(); vibrate(30); };
    bottom.appendChild(t);
  });
  updateUI();
  navigate('home');
  window.addEventListener('resize',resizeCanvas);
})();

const canVibrate = 'vibrate' in navigator;
function vibrate(ms){ if(canVibrate) navigator.vibrate(ms); }

function updateUI(){
  document.querySelectorAll('.tool').forEach(el=>el.classList.toggle('active',el.dataset.tool===tool));
  document.querySelectorAll('.color').forEach(el=>el.classList.toggle('active',el.style.background===color));
}

function navigate(screen){
  prevScreen = currentScreen;
  currentScreen = screen;
  ['home','library','pageSelect','drawing'].forEach(id=>document.getElementById(id).style.display='none');
  if(screen==='home') document.getElementById('home').style.display='flex';
  else if(screen==='library') loadLibrary();
  else if(screen==='pageSelect') loadPageSelect();
  else if(screen==='drawing') document.getElementById('drawing').style.display='flex';
}

function loadLibrary(){
  const lib=document.getElementById('library');
  lib.innerHTML='<h2>My Album</h2>';
  saved.forEach(s=>{ const i=document.createElement('img'); i.src=s; lib.appendChild(i); });
  lib.appendChild(document.querySelector('#library button'));
  lib.style.display='flex';
}

function loadPageSelect(){
  const ps=document.getElementById('pageSelect');
  ps.innerHTML='<h2>Colouring Book</h2>';
  drawings.forEach((src,i)=>{
    const im=document.createElement('img');
    im.src=src;
    im.onclick=()=>{ navigate('drawing'); loadPage(i); };
    ps.appendChild(im);
  });
  ps.appendChild(document.querySelector('#pageSelect button'));
  ps.style.display='flex';
}

function loadPage(i){
  img.onload=()=>{ scale=1; tx=ty=0; ctx.resetTransform(); redrawFull(); push(); };
  img.src=drawings[i]+'?v='+Date.now();
  resizeCanvas();
}

function resizeCanvas(){
  const r=document.getElementById('canvas-container').getBoundingClientRect();
  canvas.width=r.width; canvas.height=r.height;
  redrawFull();
}

function redrawImage(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img,0,0,img.width,img.height,0,0,canvas.width,canvas.height);
}

function redrawFull(){
  redrawImage();
  if(undoStack.length) ctx.putImageData(undoStack[undoStack.length-1],0,0);
}

function push(){
  if(undoStack.length>=30) undoStack.shift();
  undoStack.push(ctx.getImageData(0,0,canvas.width,canvas.height));
  redoStack=[];
}

function undo(){
  if(undoStack.length<2) return;
  redoStack.push(undoStack.pop());
  ctx.putImageData(undoStack[undoStack.length-1],0,0);
}

function redo(){
  if(!redoStack.length) return;
  undoStack.push(redoStack.pop());
  ctx.putImageData(undoStack[undoStack.length-1],0,0);
}

function save(){
  saved.push(canvas.toDataURL());
  localStorage.setItem(STORAGE_KEY,JSON.stringify(saved));
  alert('Saved!');
}

function download(){
  const a=document.createElement('a');
  a.href=canvas.toDataURL();
  a.download='coloring.png';
  a.click();
}

function clearCanvas(){
  redrawImage();
  push();
}

function getXY(e){
  const rect=canvas.getBoundingClientRect();
  const x=(e.clientX||e.touches[0].clientX)-rect.left;
  const y=(e.clientY||e.touches[0].clientY)-rect.top;
  const pt=new DOMPoint(x,y);
  const inv=ctx.getTransform().inverse();
  const loc=pt.matrixTransform(inv);
  return {x:Math.floor(loc.x),y:Math.floor(loc.y)};
}

function onPointer(e){
  if(!img.src) return;
  const p=getXY(e);
  const bg={r:255,g:246,b:224,a:255};
  const dur=tool==='bucket'?50:100;
  vibrate(dur); clickSound.play();
  const id=ctx.getImageData(0,0,canvas.width,canvas.height),d=id.data;
  if(tool==='bucket') flood(d,p.x,p.y,hexToRGBA(color),25,canvas.width,canvas.height);
  else flood(d,p.x,p.y,bg,25,canvas.width,canvas.height);
  ctx.putImageData(id,0,0); push();
}

canvas.addEventListener('click',onPointer);
canvas.addEventListener('mousedown',e=>{isDrag=true;start={x:e.clientX,y:e.clientY}});
canvas.addEventListener('mousemove',e=>{
  if(!isDrag)return;
  tx+=e.clientX-start.x; ty+=e.clientY-start.y;
  start={x:e.clientX,y:e.clientY};
  ctx.setTransform(scale,0,0,scale,tx,ty);
  redrawFull();
});
canvas.addEventListener('mouseup',_=>isDrag=false);
canvas.addEventListener('mouseleave',_=>isDrag=false);

canvas.addEventListener('touchstart',e=>{
  if(e.touches.length===1){isDrag=true;start={x:e.touches[0].clientX,y:e.touches[0].clientY}}
  else if(e.touches.length===2){lastDist=getDist(e);start=getMid(e);}
});
canvas.addEventListener('touchmove',e=>{
  e.preventDefault();
  if(e.touches.length===1 && isDrag){
    tx+=e.touches[0].clientX-start.x;
    ty+=e.touches[0].clientY-start.y;
    start={x:e.touches[0].clientX,y:e.touches[0].clientY};
    ctx.setTransform(scale,0,0,scale,tx,ty);
    redrawFull();
  } else if(e.touches.length===2){
    const newD=getDist(e),m=getMid(e);
    let f=newD/lastDist; f=1+(f-1)/10;
    const bx=(m.x-tx)/scale,by=(m.y-ty)/scale;
    scale*=f; tx=m.x-bx*scale; ty=m.y-by*scale;
    lastDist=newD;
    ctx.setTransform(scale,0,0,scale,tx,ty);
    redrawFull();
  }
},{passive:false});
canvas.addEventListener('touchend',()=>{isDrag=false;if(event.touches.length<2)lastDist=null});

function getDist(e){return Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);}
function getMid(e){return{x:(e.touches[0].clientX+e.touches[1].clientX)/2,y:(e.touches[0].clientY+e.touches[1].clientY)/2};}

function flood(data,x,y,c,t,w,h){
  const startIdx=(y*w+x)*4, base=data.slice(startIdx,startIdx+4);
  const match=px=>px.every((v,i)=>Math.abs(v-base[i])<t);
  const stack=[{x,y}],vis=new Uint8Array(w*h);
  while(stack.length){
    const p=stack.pop(),i=(p.y*w+p.x)*4;
    if(p.x<0||p.x>=w||p.y<0||p.y>=h||vis[p.y*w+p.x]||!match(data.slice(i,i+4)))continue;
    vis[p.y*w+p.x]=1;
    data[i]=c.r; data[i+1]=c.g; data[i+2]=c.b; data[i+3]=c.a;
    stack.push({x:p.x+1,y:p.y},{x:p.x-1,y:p.y},{x:p.x,y:p.y+1},{x:p.x,y:p.y-1});
  }
}

function hexToRGBA(hex){
  const tmp=document.createElement('div');tmp.style.color=hex;document.body.appendChild(tmp);
  const [r,g,b]=getComputedStyle(tmp).color.match(/\d+/g).map(Number);
  document.body.removeChild(tmp);
  return {r,g,b,a:255};
}
</script>
</body>
</html>
