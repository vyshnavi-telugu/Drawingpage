<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Coloring Book App</title>
  <style>
    html, body {
      margin:0; padding:0;
      width:100%; height:100%;
      overflow:hidden;
      font-family:sans-serif;
      display:flex; flex-direction:column;
    }
    #home, #library, #pageSelect, #drawing {
      display:none;
      flex:1;
      width:100%; height:100%;
      flex-direction:column;
      align-items:center;
      justify-content:center;
    }
    #home {
      background:url('https://upload.wikimedia.org/wikipedia/commons/thumb/d/d1/Rangoli_Design.jpg/800px-Rangoli_Design.jpg') center/cover no-repeat;
    }
    .home-btn { background:none;border:none;margin:20px;cursor:pointer; }
    .home-btn img { width:220px; }
    #pageSelect img, #library img {
      width:180px; margin:12px; cursor:pointer;
      border:3px solid #333; border-radius:8px;
    }
    #top-bar, #bottom-bar {
      position:absolute; left:0; width:100%;
      background:#eee; padding:10px; z-index:10;
      display:flex; align-items:center; justify-content:space-around;
    }
    #top-bar { top:0; }
    #bottom-bar { bottom:0; flex-wrap:wrap; }
    .tool, .color {
      margin:6px; padding:8px;
      border:1px solid #333; border-radius:6px;
      font-size:22px; background:#fff; cursor:pointer;
    }
    .color { width:32px; height:32px; }
    .active { border:2px solid red !important; }
    #canvas-container {
      flex:1; width:100%; height:100%;
      position:relative; overflow:hidden;
      display:flex; align-items:center; justify-content:center;
      touch-action:none;
    }
    canvas {
      border:1px solid #ccc;
      transform-origin:top left;
    }
    h2 { margin-top:60px; color:#222; }
    .download-btn {
      position:absolute; top:50px; right:10px;
      padding:6px 12px; background:#28a;
      color:#fff; border:none; border-radius:4px;
      cursor:pointer; z-index:11;
    }
  </style>
</head>
<body>

  <div id="home">
    <button class="home-btn" onclick="showLibrary()">
      <img src="https://img.icons8.com/clouds/256/000000/opened-folder.png" alt="Library"/>
    </button>
    <button class="home-btn" onclick="showPageSelect()">
      <img src="https://img.icons8.com/clouds/256/000000/paint-palette.png" alt="Coloring Book"/>
    </button>
  </div>

  <div id="library"></div>
  <div id="pageSelect"></div>

  <div id="drawing">
    <div id="top-bar">
      <button onclick="undo()">Undo</button>
      <button onclick="redo()">Redo</button>
      <button onclick="save()">Save</button>
      <button class="download-btn" onclick="downloadDrawing()">Download</button>
    </div>
    <div id="canvas-container">
      <canvas id="drawCanvas" width="600" height="800"></canvas>
    </div>
    <div id="bottom-bar">
      <div class="tool" data-tool="bucket">ðŸª£</div>
      <div class="tool" data-tool="eraser">ðŸ§½</div>
    </div>
  </div>

<script>
// -- Data & setup --
const drawings = [
  'https://i.postimg.cc/TPZTn08W/0f00c43f3775ba5fcce443f4885aa56e.jpg',
  'https://i.postimg.cc/Bv8q8yz0/36-girl-with-butterfly-wings-to-color.jpg',
  'https://i.postimg.cc/pLsT5KXD/6331b296558cf1f8f7fd87cc9154f432.jpg'
];
const savedImages = [];
const canvas = document.getElementById('drawCanvas');
const ctx = canvas.getContext('2d');
const img = new Image();
img.crossOrigin = 'anonymous';

let tool='bucket', color='black';
const undoStack=[], redoStack=[];
let scale=1, lastDist=0;
const container = document.getElementById('canvas-container');

// -- Show/hide UI screens --
function showHome(){ hideAll(); document.getElementById('home').style.display='flex'; }
function showLibrary(){
  hideAll(); const lib = document.getElementById('library');
  lib.style.display='flex'; lib.style.flexWrap='wrap'; lib.innerHTML = '<h2>Saved Images</h2>';
  savedImages.forEach(src=>{ let i=document.createElement('img'); i.src=src; lib.appendChild(i); });
  let b=document.createElement('button'); b.textContent='â¬… Back'; b.onclick=showHome; lib.appendChild(b);
}
function showPageSelect(){
  hideAll(); const ps=document.getElementById('pageSelect');
  ps.style.display='flex'; ps.style.flexWrap='wrap'; ps.innerHTML='<h2>Select a Drawing</h2>';
  drawings.forEach((d,i)=>{ let t=document.createElement('img'); t.src=d;t.onclick=()=>loadPage(i); ps.appendChild(t);});
  let b=document.createElement('button'); b.textContent='â¬… Back'; b.onclick=showHome; ps.appendChild(b);
}
function hideAll(){
  ['home','library','pageSelect','drawing'].forEach(id=>document.getElementById(id).style.display='none');
}

// -- Load/color a page --
function loadPage(i){
  hideAll(); document.getElementById('drawing').style.display='flex';
  resetTransform();
  img.onload=()=>{
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img,0,0,canvas.width,canvas.height);
    pushUndo();
  }
  img.src = drawings[i] + '?v='+Date.now();
}

// -- tools/colors UI --
document.querySelectorAll('.tool').forEach(el=>el.onclick=()=>{ tool=el.dataset.tool; updateUI(); });
const colorList = ['black','gray','red','orange','yellow','green','blue','purple','pink','brown','white','cyan','magenta','lime','gold','navy'];
colorList.forEach(c=>{
  let div = document.createElement('div');
  div.className = 'color';
  div.style.background = c;
  div.onclick = ()=>{ color = c; updateUI(); };
  document.getElementById('bottom-bar').appendChild(div);
});
function updateUI(){
  document.querySelectorAll('.tool').forEach(el=>el.classList.toggle('active', el.dataset.tool===tool));
  document.querySelectorAll('.color').forEach(el=>el.classList.toggle('active', el.style.background === color));
}

// -- Undo/redo & drawing actions --
function pushUndo(){ undoStack.push(canvas.toDataURL()); if(undoStack.length>50) undoStack.shift(); redoStack.length=0; }
function undo(){ if(undoStack.length<2) return; redoStack.push(undoStack.pop()); restore(undoStack[undoStack.length-1]); }
function redo(){ if(!redoStack.length) return; let d=redoStack.pop(); undoStack.push(d); restore(d); }
function restore(src){ let i=new Image(); i.onload=()=>ctx.drawImage(i,0,0); i.src=src; }
function getXY(e){
  const r = canvas.getBoundingClientRect();
  return { x:Math.floor((e.clientX - r.left)/scale), y:Math.floor((e.clientY - r.top)/scale) };
}
canvas.addEventListener('mousedown', e=>handleInput(e));
canvas.addEventListener('touchstart', e=>handleInput(e.touches[0]));
function handleInput(e){
  const {x,y} = getXY(e);
  if(tool==='bucket'){
    const imgd = ctx.getImageData(0,0,canvas.width,canvas.height);
    const rgba = hexToRGBA(color);
    floodfill(imgd.data, x,y, rgba,25, imgd.width,imgd.height);
    ctx.putImageData(imgd,0,0);
    pushUndo();
  } else {
    ctx.globalCompositeOperation='destination-out';
    ctx.beginPath(); ctx.arc(x,y,10,0,2*Math.PI); ctx.fill();
    ctx.globalCompositeOperation='source-over';
    pushUndo();
  }
}
function floodfill(data,sx,sy,fill,tol,w,h){
  const idx=(sy*w+sx)*4;
  const base=data.slice(idx,idx+4);
  const diff=(p1,p2)=>Math.abs(p1[0]-p2[0])+Math.abs(p1[1]-p2[1])+Math.abs(p1[2]-p2[2])+Math.abs(p1[3]-p2[3]);
  const match=px=>diff(px,base)<tol;
  const stack=[{x:sx,y:sy}];
  const vis=new Uint8Array(w*h);
  while(stack.length){
    const p=stack.pop();
    if(p.x<0||p.x>=w||p.y<0||p.y>=h) continue;
    if(vis[p.y*w+p.x]) continue;
    vis[p.y*w+p.x]=1;
    const i=(p.y*w+p.x)*4;
    const cur=data.slice(i,i+4);
    if(!match(cur)) continue;
    data[i]=fill.r; data[i+1]=fill.g; data[i+2]=fill.b; data[i+3]=fill.a;
    stack.push({x:p.x+1,y:p.y}); stack.push({x:p.x-1,y:p.y});
    stack.push({x:p.x,y:p.y+1}); stack.push({x:p.x,y:p.y-1});
  }
}
function hexToRGBA(hex){
  const tmp=document.createElement('div');
  tmp.style.color = hex;
  document.body.appendChild(tmp);
  const [r,g,b] = getComputedStyle(tmp).color.match(/\d+/g).map(Number);
  document.body.removeChild(tmp);
  return {r,g,b,a:255};
}

// -- Zoom via pinch gestures --
container.addEventListener('touchmove', e=>{
  if(e.touches.length===2){
    e.preventDefault();
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    const dist = Math.hypot(dx,dy);
    if(lastDist){
      scale = Math.min(3, Math.max(0.5, scale + (dist-lastDist)*0.005));
      canvas.style.transform = `scale(${scale})`;
    }
    lastDist = dist;
  }
}, {passive:false});
container.addEventListener('touchend', e=>{ if(e.touches.length<2) lastDist = 0; });

// -- Save to session + localStorage persistence --
function save(){
  const data = canvas.toDataURL();
  savedImages.push(data);
  alert('Saved â€” visible in Library now!');
  localStorage.setItem('savedImages', JSON.stringify(savedImages));
}
window.addEventListener('DOMContentLoaded', ()=>{
  const arr = JSON.parse(localStorage.getItem('savedImages') || '[]');
  if(arr.length){
    savedImages.push(...arr);
  }
});

// -- Download drawing as PNG --
function downloadDrawing(){
  canvas.toBlob(blob=>{
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `coloring_${Date.now()}.png`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  });
}

// -- Helpers & init --
function resetTransform(){
  scale=1;
  canvas.style.transform = 'scale(1)';
}
showHome();

</script>
</body>
  </html>
