<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<style>
  html,body{margin:0;padding:0;height:100%;overflow:hidden;background:#fff6e0;font-family:'Comic Sans MS';}
  #home,#library,#pageSelect,#drawing{display:none;height:100%;flex-direction:column;}
  #home{display:flex;justify-content:center;align-items:center;background:linear-gradient(to bottom,#ffdee9,#b5fffc);}
  .home-btn{border:none;background:none;cursor:pointer;margin:20px;}
  .home-btn img{width:180px;}
  #library,#pageSelect{display:flex;flex-wrap:wrap;padding:10px;overflow-y:auto;justify-content:center;}
  #library img,#pageSelect img{width:150px;margin:8px;border:3px solid #f06292;border-radius:10px;cursor:pointer;}
  #top-bar,#bottom-bar{display:flex;justify-content:center;gap:8px;padding:8px;background:#ffe0f0;position:relative;z-index:10;}
  #canvas-container{flex:1;position:relative;touch-action:none;}
  canvas{background:#fff;width:100%;height:100%;display:block;}
  button, .tool, .color{padding:8px;border:none;border-radius:8px;font-size:18px;cursor:pointer;background:#f06292;color:#fff;}
  .tool{width:32px;height:32px;display:flex;align-items:center;justify-content:center;}
  .color{width:32px;height:32px;margin:4px;border:2px solid #f06292;border-radius:50%;}
  .active{border:3px solid #ff4081 !important;}
</style>
</head>
<body>
  <div id="home">
    <button class="home-btn" onclick="showLibrary()"><img src="https://img.icons8.com/clouds/200/opened-folder.png"/></button>
    <button class="home-btn" onclick="showPageSelect()"><img src="https://img.icons8.com/clouds/200/paint-palette.png"/></button>
  </div>

  <div id="library"><button onclick="showHome()">â¬… Back</button></div>
  <div id="pageSelect"><button onclick="showHome()">â¬… Back</button></div>

  <div id="drawing" style="display:flex;flex-direction:column;">
    <div id="top-bar">
      <button onclick="undo()">Undo</button>
      <button onclick="redo()">Redo</button>
      <button id="bucketBtn" onclick="selectTool('bucket')">ðŸª£</button>
      <button id="eraserBtn" onclick="selectTool('eraser')">ðŸ§½</button>
      <button onclick="save()">Save</button>
      <button onclick="download()">Download</button>
    </div>
    <div id="canvas-container"><canvas id="cv" width="800" height="800"></canvas></div>
    <div id="bottom-bar"></div>
  </div>

<script>
  const drawings = [
    'https://i.postimg.cc/TPZTn08W/0f00c43f3775ba5fcce443f4885aa56e.jpg',
    'https://i.postimg.cc/JnZMxXmY/bunny-carrot-coloring-page-600nw-2414476443.jpg',
    'https://i.postimg.cc/Bv8q8yz0/36-girl-with-butterfly-wings-to-color.jpg',
    'https://i.postimg.cc/pLsT5KXD/6331b296558cf1f8f7fd87cc9154f432.jpg',
    'https://i.postimg.cc/2yYmK5Sk/7113dc553901fe5719b2c9e221449e28.jpg'
  ];
  const savedImages = JSON.parse(localStorage.getItem('lib')) || [];
  
  // Elements
  const home = document.getElementById('home'),
        library = document.getElementById('library'),
        pageSelect = document.getElementById('pageSelect'),
        drawing = document.getElementById('drawing'),
        canvas = document.getElementById('cv'),
        ctx = canvas.getContext('2d');
  
  // States
  let img = new Image(), tool = 'bucket', color = 'black';
  const undoStack = [], redoStack = [];
  let scale = 1, offsetX = 0, offsetY = 0;
  let lastDist = 0, panning = false, panStart = {};
  
  // Setup
  showHome();
  img.crossOrigin = 'anonymous';
  img.onload = () => { drawImage(); pushUndo(); };
  
  // UI tool buttons
  document.getElementById('bucketBtn').classList.add('active');
  document.getElementById('eraserBtn').onclick = () => selectTool('eraser');
  window.selectTool = t => {
    tool = t;
    document.getElementById('bucketBtn').classList.toggle('active', t==='bucket');
    document.getElementById('eraserBtn').classList.toggle('active', t==='eraser');
  };
  
  // Color palette
  const colors = ['black','gray','red','orange','yellow','green','blue','purple','pink','tan','brown','white'];
  colors.forEach(c => {
    const d = document.createElement('div');
    d.className = 'color';
    d.style.background = c;
    if(c === color) d.classList.add('active');
    d.onclick = () => {
      color = c;
      document.querySelectorAll('.color').forEach(e=>e.classList.toggle('active', e===d));
    };
    document.getElementById('bottom-bar').appendChild(d);
  });
  
  // Library and page select
  window.showHome = () => { home.style.display='flex'; library.style.display=pageSelect.style.display=drawing.style.display='none'; };
  window.showLibrary = () => {
    home.style.display=pageSelect.style.display=drawing.style.display='none';
    library.innerHTML = '<button onclick="showHome()">â¬… Back</button>';
    library.style.display='flex';
    savedImages.forEach(src => {
      const im = document.createElement('img');
      im.src = src;
      library.appendChild(im);
    });
  };
  window.showPageSelect = () => {
    home.style.display=library.style.display=drawing.style.display='none';
    pageSelect.innerHTML = '<button onclick="showHome()">â¬… Back</button>';
    pageSelect.style.display='flex';
    drawings.forEach((s,i) => {
      const t = document.createElement('img');
      t.src = s;
      t.onclick = () => loadPage(i);
      pageSelect.appendChild(t);
    });
  };
  
  // Load coloring page
  window.loadPage = i => {
    home.style.display=library.style.display=pageSelect.style.display='none';
    drawing.style.display = 'flex';
    img.src = drawings[i] + '?v='+Date.now();
  };
  
  // Draw and control canvas
  function drawImage(){
    ctx.setTransform(scale, 0, 0, scale, offsetX, offsetY);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  }
  
  // Undo/Redo
  window.undo = () => {
    if(undoStack.length < 2) return;
    redoStack.push(undoStack.pop());
    const data = undoStack[undoStack.length-1];
    const i = new Image();
    i.onload = () => { drawImage(); ctx.drawImage(i,0,0); };
    i.src = data;
  };
  window.redo = () => {
    if(!redoStack.length) return;
    const data = redoStack.pop();
    undoStack.push(data);
    const i = new Image();
    i.onload = () => { drawImage(); ctx.drawImage(i,0,0); };
    i.src = data;
  };
  function pushUndo(){
    undoStack.push(canvas.toDataURL());
    if(undoStack.length > 30) undoStack.shift();
    redoStack.length = 0;
  }
  
  // Touch controls & tap-to-fill
  canvas.addEventListener('touchstart', e => {
    if(e.touches.length === 1){
      panning = true;
      panStart = { x: e.touches[0].clientX - offsetX, y: e.touches[0].clientY - offsetY };
    } else if(e.touches.length === 2){
      lastDist = dist(e.touches[0], e.touches[1]);
    }
  });
  
  canvas.addEventListener('touchmove', e => {
    e.preventDefault();
    if(e.touches.length === 1 && panning){
      offsetX = e.touches[0].clientX - panStart.x;
      offsetY = e.touches[0].clientY - panStart.y;
      drawImage();
    } else if(e.touches.length === 2){
      const d = dist(e.touches[0], e.touches[1]);
      const z = d / lastDist;
      lastDist = d;
      const m = mid(e.touches[0], e.touches[1]);
      offsetX -= (m.x - offsetX) * (z - 1);
      offsetY -= (m.y - offsetY) * (z - 1);
      scale *= z;
      drawImage();
    }
  }, {passive:false});
  
  canvas.addEventListener('touchend', e => {
    if(e.changedTouches.length === 1 && !panning){
      const t = e.changedTouches[0];
      const x = (t.clientX - canvas.getBoundingClientRect().left - offsetX)/scale;
      const y = (t.clientY - canvas.getBoundingClientRect().top - offsetY)/scale;
      if(tool === 'bucket'){
        floodFill(Math.floor(x), Math.floor(y));
        pushUndo();
      } else {
        ctx.setTransform(scale,0,0,scale,offsetX,offsetY);
        ctx.clearRect(x-10, y-10, 20, 20);
        pushUndo();
      }
    }
    if(e.touches.length === 0) panning = false;
  });
  
  function dist(a,b){ return Math.hypot(a.clientX-b.clientX, a.clientY-b.clientY); }
  function mid(a,b){ return { x:(a.clientX+b.clientX)/2, y:(a.clientY+b.clientY)/2 }; }
  
  // Flood-fill algorithm
  function floodFill(sx, sy){
    const w = canvas.width, h = canvas.height;
    const imgd = ctx.getImageData(0,0,w,h), data = imgd.data;
    const base = getPixel(data, sx, sy, w);
    const fillColor = hexToRGBA(color);
    if(!colorMatch(base, fillColor)){
      const stack = [{x: sx, y: sy}];
      while(stack.length){
        const p = stack.pop(), idx = (p.y*w+p.x)*4;
        if(!colorMatch(getPixel(data, p.x, p.y, w), base)) continue;
        setPixel(data, idx, fillColor);
        if(p.x>0) stack.push({x:p.x-1,y:p.y});
        if(p.x<w-1) stack.push({x:p.x+1,y:p.y});
        if(p.y>0) stack.push({x:p.x,y:p.y-1});
        if(p.y<h-1) stack.push({x:p.x,y:p.y+1});
      }
      ctx.putImageData(imgd,0,0);
    }
  }
  function getPixel(data,x,y,w){ const i=(y*w+x)*4; return {r:data[i],g:data[i+1],b:data[i+2],a:data[i+3]}; }
  function setPixel(data,i,c){ data[i]=c.r; data[i+1]=c.g; data[i+2]=c.b; data[i+3]=c.a; }
  function colorMatch(a,b){return a.r===b.r && a.g===b.g && a.b===b.b && a.a===b.a;}
  function hexToRGBA(hex){
    const tmp = document.createElement('div');
    tmp.style.color = hex;
    document.body.appendChild(tmp);
    const [r,g,b] = getComputedStyle(tmp).color.match(/\d+/g).map(Number);
    document.body.removeChild(tmp);
    return { r, g, b, a: 255 };
  }
  
  // Save & download
  window.save = () => {
    savedImages.unshift(canvas.toDataURL());
    localStorage.setItem('lib', JSON.stringify(savedImages));
    alert('Saved to Library!');
  };
  window.download = () => {
    const a = document.createElement('a');
    a.href = canvas.toDataURL();
    a.download = 'coloring.png';
    a.click();
  };
</script>
</body>
</html>
