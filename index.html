<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<title>Coloring Book App</title>
<style>
  html, body { margin:0; padding:0; height:100%; background:#fff6e0; touch-action:none; font-family:'Comic Sans MS', cursive; }
  #home,#library,#pageSelect,#drawing { display:none; flex-direction:column; align-items:center; justify-content:center; height:100%; }
  #home{display:flex; background:linear-gradient(to bottom right,#ffdee9,#b5fffc);}
  .home-btn{margin:20px;border:none;background:none;cursor:pointer;}
  .home-btn img{width:180px;}
  #pageSelect img,#library img{width:150px;margin:10px;border:3px solid #f06292;border-radius:10px;cursor:pointer;}
  #top-bar,#bottom-bar{display:flex; flex-wrap:wrap; justify-content:center; gap:10px; background:#ffe0f0; padding:12px;}
  button,.tool,.color{padding:10px 14px; font-size:18px; border:none;border-radius:10px;cursor:pointer;
    background:#f06292;color:white;box-shadow:2px 2px 6px rgba(0,0,0,0.2);}
  .tool,.color{width:38px;height:38px;display:flex;align-items:center;justify-content:center;}
  .color{border:2px solid #f06292;padding:0;}
  .active{border:3px solid #ff4081 !important;}
  #canvas-container{flex:1;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;background:white;}
  canvas{border-radius:10px; touch-action:none; transform-origin:0 0; transition:transform 0.1s;}
</style>
</head>
<body>

<div id="home">
  <button class="home-btn" onclick="showLibrary()"><img src="https://img.icons8.com/clouds/200/000000/opened-folder.png"/></button>
  <button class="home-btn" onclick="showPageSelect()"><img src="https://img.icons8.com/clouds/200/paint-palette.png"/></button>
</div>
<div id="library"></div><div id="pageSelect"></div>

<div id="drawing">
  <div id="top-bar">
    <button onclick="undo()">Undo</button><button onclick="redo()">Redo</button>
    <button onclick="save()">Save</button><button onclick="download()">Download</button>
    <button onclick="clearCanvas()">Clear</button>
  </div>
  <div id="canvas-container">
    <canvas id="drawCanvas" width="1000" height="1000"></canvas>
  </div>
  <div id="bottom-bar">
    <div class="tool" data-tool="bucket">ðŸª£</div>
    <div class="tool" data-tool="eraser">ðŸ§½</div>
    <!-- More colors -->
  </div>
</div>

<audio id="clickSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_059f6bff69.mp3?filename=click-124467.mp3"></audio>

<script>
// Utility and globals
const canvas=document.getElementById('drawCanvas'),ctx=canvas.getContext('2d');
const img=new Image(); img.crossOrigin='anonymous';
const clickSound=document.getElementById('clickSound');
let tool='bucket',color='black',scale=1,translateX=0,translateY=0;
let isDragging=false,dragStart=null,lastDist=null;
const drawings=['https://i.postimg.cc/TPZTn08W/0f00c43f3775ba5fcce443f4885aa56e.jpg','https://i.postimg.cc/JnZMxXmY/bunny-carrot-coloring-page-600nw-2414476443.jpg'];
const savedImages=[],undoStack=[],redoStack=[];

function playClick(){ clickSound.currentTime=0; clickSound.play(); }
function showHome(){ hideAll();document.getElementById('home').style.display='flex';}
function showLibrary(){
  hideAll(); const lib=document.getElementById('library');
  lib.style.display='flex'; lib.innerHTML='<h2>Saved</h2>';
  savedImages.forEach(src=>{let i=document.createElement('img');i.src=src;lib.appendChild(i);});
  let b=document.createElement('button');b.textContent='â¬… Back';b.onclick=showHome; lib.appendChild(b);
}
function showPageSelect(){
  hideAll(); const ps=document.getElementById('pageSelect');
  ps.style.display='flex'; ps.innerHTML='<h2>Pick a Page</h2>';
  drawings.forEach((s,i)=>{let t=document.createElement('img');t.src=s; t.onclick=()=>loadPage(i);ps.appendChild(t);});
  let b=document.createElement('button');b.textContent='â¬… Back';b.onclick=showHome; ps.appendChild(b);
}
function loadPage(i){
  hideAll(); document.getElementById('drawing').style.display='flex';
  img.onload=()=>{ resetTransform(); drawImageScaled(img,ctx); pushUndo(); };
  img.src=drawings[i]+'?v='+Date.now();
}
function hideAll(){ ['home','library','pageSelect','drawing'].forEach(id=>document.getElementById(id).style.display='none'); }

document.querySelectorAll('.tool').forEach(el=>el.onclick=e=>{
  playClick(); tool=el.dataset.tool; updateUI();
});
const palette=['black','gray','red','orange','yellow','green','blue','purple','pink','peach','tan','brown','white','cyan','magenta','navy','skin'];
palette.forEach(c=>{
  let d=document.createElement('div'); d.className='color'; d.style.background=c;
  d.onclick=()=>{playClick();color=c;updateUI();}; document.getElementById('bottom-bar').appendChild(d);
});
function updateUI(){
  document.querySelectorAll('.tool').forEach(el=>el.classList.toggle('active',el.dataset.tool===tool));
  document.querySelectorAll('.color').forEach(el=>el.classList.toggle('active',el.style.background===color));
}

// Interactions
canvas.addEventListener('mousedown',startDrag);
canvas.addEventListener('mousemove',dragMove);
canvas.addEventListener('mouseup',endDrag);
canvas.addEventListener('click',handlePaint);
canvas.addEventListener('touchstart',e=>handlePaint(e.touches[0]));
canvas.addEventListener('touchmove',pinchZoomMove,{passive:false});
canvas.addEventListener('touchend',()=>lastDist=null);

function pinchZoomMove(e){
  if(e.touches.length===2){
    e.preventDefault();
    const dx=e.touches[0].clientX-e.touches[1].clientX, dy=e.touches[0].clientY-e.touches[1].clientY;
    const d=Math.sqrt(dx*dx+dy*dy);
    if(lastDist){ scale*=d/lastDist; scale=Math.max(0.3,Math.min(scale,3)); applyTransform(); }
    lastDist=d;
  }
}
function startDrag(e){
  if(e.touches?.length===2) return;
  isDragging=true;
  dragStart={x:e.clientX,y:e.clientY};
}
function dragMove(e){
  if(!isDragging) return;
  translateX+=e.clientX-dragStart.x; translateY+=e.clientY-dragStart.y;
  dragStart={x:e.clientX,y:e.clientY};
  applyTransform();
}
function endDrag(){ isDragging=false; }

function applyTransform(){
  canvas.style.transform=`translate(${translateX}px,${translateY}px) scale(${scale})`;
}

function handlePaint(e){
  if(!img.src) return;
  const r=canvas.getBoundingClientRect();
  const x=Math.floor((e.clientX-r.left-translateX)/scale);
  const y=Math.floor((e.clientY-r.top-translateY)/scale);
  if(tool==='bucket'){ playClick(); 
    let imgd=ctx.getImageData(0,0,canvas.width,canvas.height);
    floodfill(imgd.data,x,y,hexToRGBA(color),25,imgd.width,imgd.height);
    ctx.putImageData(imgd,0,0); pushUndo();
  } else if(tool==='eraser'){
    playClick();
    ctx.globalCompositeOperation='destination-out';
    ctx.beginPath(); ctx.arc(x,y,10,0,2*Math.PI); ctx.fill();
    ctx.globalCompositeOperation='source-over'; pushUndo();
  }
}

// Canvas reset helpers
function resetTransform(){ scale=1;translateX=0;translateY=0;applyTransform(); }
function drawImageScaled(img,ctx){
  const c=ctx.canvas, hRatio=c.width/img.width, vRatio=c.height/img.height;
  const ratio=Math.min(hRatio,vRatio);
  const shiftX=(c.width-img.width*ratio)/2,shiftY=(c.height-img.height*ratio)/2;
  ctx.clearRect(0,0,c.width,c.height);
  ctx.drawImage(img,0,0,img.width,img.height,shiftX,shiftY,img.width*ratio,img.height*ratio);
}

// Floodâ€‘fill paint
function floodfill(data,sx,sy,fill,tol,w,h){
  const idx=(sy*w+sx)*4,base=data.slice(idx,idx+4);
  const match=(px,base)=>px.every((v,i)=>Math.abs(v-base[i])<tol);
  const stack=[{x:sx,y:sy}],visited=new Uint8Array(w*h);
  while(stack.length){
    const {x,y}=stack.pop();
    if(x<0||x>=w||y<0||y>=h)continue;
    const i=(y*w+x)*4;
    if(visited[y*w+x]||!match(data.slice(i,i+4),base))continue;
    visited[y*w+x]=1;
    data[i]=fill.r;data[i+1]=fill.g;data[i+2]=fill.b;data[i+3]=fill.a;
    stack.push({x:x+1,y},{x:x-1,y},{x,y:y+1},{x,y:y-1});
  }
}
