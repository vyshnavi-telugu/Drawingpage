<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>Coloring Book App</title>
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; font-family:sans-serif; }
    body { display:flex; flex-direction:column; }
    #home, #library, #pageSelect, #drawing {
      display:none; flex:1; align-items:center; justify-content:center;
    }
    #home {
      background: #f5f5f5 url('https://upload.wikimedia.org/wikipedia/commons/d/d1/Rangoli_Design.jpg') center/cover no-repeat;
    }
    .home-btn { margin:20px; border:none; background:none; cursor:pointer;
      display:flex; flex-direction:column; align-items:center;
    }
    .home-btn img { width:200px; }
    .home-label {
      margin-top:8px; font-size:18px; font-weight:bold;
      color:#fff; text-shadow:1px 1px 2px rgba(0,0,0,0.7);
    }
    #top-bar {
      display:flex; justify-content:space-around;
      width:100%; background:#eee; padding:8px;
    }
    #bottom-bar {
      position:absolute; bottom:0; width:100%; background:#eee;
      padding:10px; display:flex; justify-content:center; flex-wrap:wrap; z-index:10;
    }
    .color, .tool {
      margin:4px; padding:6px;
      border:1px solid #333; border-radius:4px;
      font-size:20px; cursor:pointer;
    }
    .color { width:28px; height:28px; }
    canvas {
      touch-action:none; user-select:none;
      width:100vw; height:calc(100vh - 100px);
      display:block; margin-bottom:60px;
    }
    .active { border:2px solid red !important; }
    #undoBtn, #redoBtn { background:skyblue; color:black; }
    #saveBtn { background:green; color:black; }
    #deleteBtn { background:red; color:black; }
    #downloadBtn { background:yellow; color:black; }
  </style>
</head>
<body>

<div id="home">
  <button class="home-btn" onclick="showLibrary()">
    <img src="https://img.icons8.com/clouds/200/000000/opened-folder.png"/>
    <div class="home-label">Library</div>
  </button>
  <button class="home-btn" onclick="showPageSelect()">
    <img src="https://img.icons8.com/clouds/200/paint-palette.png"/>
    <div class="home-label">Coloring Book</div>
  </button>
</div>

<div id="library"></div>
<div id="pageSelect"></div>
<div id="drawing">
  <div id="top-bar">
    <button id="undoBtn">Undo</button>
    <button id="redoBtn">Redo</button>
    <button id="saveBtn">Save</button>
    <button id="deleteBtn">Delete</button>
    <button id="downloadBtn">Download</button>
  </div>
  <canvas id="drawCanvas"></canvas>
  <div id="bottom-bar"></div>
</div>

<script>
const drawings = [
 'https://i.postimg.cc/TPZTn08W/0f00c43f3775ba5fcce443f4885aa56e.jpg',
  'https://i.postimg.cc/Bv8q8yz0/36-girl-with-butterfly-wings-to-color.jpg',
  'https://i.postimg.cc/pLsT5KXD/6331b296558cf1f8f7fd87cc9154f432.jpg',
    'https://i.postimg.cc/2yYmK5Sk/7113dc553901fe5719b2c9e221449e28.jpg',
    'https://i.postimg.cc/MKxKs9n7/adorable-fun-kids-coloring-page-delight-freepik-908673-3027.jpg',
    'https://i.postimg.cc/jS1TrcSk/Barbie-10.jpg',
    'https://i.postimg.cc/FsDmTN5v/Barbie-24.jpg',
    'https://i.postimg.cc/j2YdYXZr/Barbie-27.jpg',
  'https://i.postimg.cc/cJ6JR6rP/bc2884b1a90b6d9db42580113054c40b.jpg', 
];
const savedImages = [];
const canvas = document.getElementById('drawCanvas'), ctx = canvas.getContext('2d');
const img = new Image(); img.crossOrigin = 'anonymous';

let tool='bucket', color='black';
let scale=1, pan={x:0,y:0}, lastTouches=[];
const panSpeed=0.2;
const undoStack=[], redoStack=[];
let baseLoaded=false;

function resizeCanvas(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight
    - document.getElementById('top-bar').offsetHeight
    - document.getElementById('bottom-bar').offsetHeight;
  redraw();
}
window.addEventListener('resize', resizeCanvas);

function redraw(){
  if(!baseLoaded) return;
  ctx.setTransform(scale,0,0,scale,pan.x,pan.y);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img, 0,0);
}
function reset(){
  scale=1; pan={x:0,y:0}; redraw();
}

// buttons
document.getElementById('undoBtn').onclick = undo;
document.getElementById('redoBtn').onclick = redo;
document.getElementById('saveBtn').onclick = save;
document.getElementById('deleteBtn').onclick = ()=>{ if(baseLoaded){ reset(); pushUndo(); } };
document.getElementById('downloadBtn').onclick = ()=>{ const a=document.createElement('a'); a.href=canvas.toDataURL(); a.download='coloring.png'; a.click(); };

// navigation
function showHome(){ hideAll(); document.getElementById('home').style.display='flex'; }
function showLibrary(){
  hideAll();
  const lib=document.getElementById('library');
  lib.style.display='flex'; lib.style.flexWrap='wrap';
  lib.innerHTML='<h2>Saved Images</h2>';
  savedImages.forEach(s => { const i=document.createElement('img'); i.src=s; lib.appendChild(i); });
  const b=document.createElement('button'); b.textContent='⬅ Back'; b.onclick=showHome; lib.appendChild(b);
}
function showPageSelect(){
  hideAll();
  const ps=document.getElementById('pageSelect');
  ps.style.display='flex'; ps.style.flexWrap='wrap';
  ps.innerHTML='<h2>Select a Drawing</h2>';
  drawings.forEach((s,i)=>{
    const e=document.createElement('img');
    e.src=s; e.onclick=()=>loadPage(i);
    ps.appendChild(e);
  });
  const b=document.createElement('button'); b.textContent='⬅ Back'; b.onclick=showHome; ps.appendChild(b);
}
function hideAll(){
  ['home','library','pageSelect','drawing'].forEach(id=>document.getElementById(id).style.display='none');
}
function loadPage(idx){
  hideAll(); document.getElementById('drawing').style.display='flex';
  img.onload = ()=>{ baseLoaded=true; reset(); resizeCanvas(); pushUndo(); };
  img.src = drawings[idx]+'?v='+Date.now();
}

// palette
const bottom=document.getElementById('bottom-bar');
['black','gray','red','orange','yellow','green','blue','purple','pink','brown','white','cyan','magenta','lime','gold','navy',
 '#ffe0bd','#ffcd94','#eac086','#ffad60','#ffe4c4']
 .forEach(c=>{
  const d=document.createElement('div');
  d.className='color'; d.style.background=c;
  d.onclick=()=>{ color=c; updateUI(); };
  bottom.appendChild(d);
});
function updateUI(){
  document.querySelectorAll('.color')
    .forEach(el=>el.classList.toggle('active', el.style.background===color));
}

// floodfill
function hexToRGBA(hex){
  const t=document.createElement('div'); t.style.color=hex; document.body.appendChild(t);
  const [r,g,b]=getComputedStyle(t).color.match(/\d+/g).map(Number);
  document.body.removeChild(t);
  return {r,g,b,a:255};
}
function floodfill(data,sx,sy,fill,tol,w,h){
  const base=data.slice((sy*w+sx)*4,(sy*w+sx)*4+4);
  const diff=(a,b)=>Math.abs(a[0]-b[0])+Math.abs(a[1]-b[1])+Math.abs(a[2]-b[2])+Math.abs(a[3]-b[3]);
  const stk=[{x:sx,y:sy}], vis=new Uint8Array(w*h);
  while(stk.length){
    const {x,y}=stk.pop(); if(x<0||y<0||x>=w||y>=h) continue;
    const idx=y*w+x; if(vis[idx]) continue; vis[idx]=1;
    const i=idx*4, px=data.slice(i,i+4);
    if(diff(px,base)>=tol) continue;
    data[i]=fill.r; data[i+1]=fill.g; data[i+2]=fill.b; data[i+3]=fill.a;
    stk.push({x:x+1,y},{x:x-1,y},{x,y:y+1},{x,y:y-1});
  }
}

// undo/redo
function pushUndo(){
  undoStack.push(canvas.toDataURL());
  if(undoStack.length>50) undoStack.shift();
  redoStack.length=0;
}
function undo(){
  if(undoStack.length<2) return;
  redoStack.push(undoStack.pop());
  restore(undoStack[undoStack.length-1]);
}
function redo(){
  if(!redoStack.length) return;
  const d=redoStack.pop(); undoStack.push(d); restore(d);
}
function restore(src){
  const i=new Image();
  i.onload=()=>{ ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(i,0,0); };
  i.src=src;
}
function save(){
  savedImages.push(canvas.toDataURL());
  alert('Saved to library!');
}

// touch for pinch-pan only & fill
canvas.addEventListener('touchstart', e=>{ lastTouches = Array.from(e.touches); });
canvas.addEventListener('touchmove', e=>{
  e.preventDefault();
  const t=e.touches;
  if(t.length===2 && baseLoaded){
    const [a,b]=t;
    const midX=(a.pageX+b.pageX)/2, midY=(a.pageY+b.pageY)/2;
    if(lastTouches.length===2){
      const dCur=Math.hypot(b.pageX-a.pageX,b.pageY-a.pageY);
      const dLast=Math.hypot(lastTouches[1].pageX-lastTouches[0].pageX, lastTouches[1].pageY-lastTouches[0].pageY);
      const factor=dCur/dLast;
      scale*=factor;
      pan.x+=(midX- (lastTouches[0].pageX+lastTouches[1].pageX)/2)*panSpeed;
      pan.y+=(midY- (lastTouches[0].pageY+lastTouches[1].pageY)/2)*panSpeed;
    }
    lastTouches=Array.from(t);
    redraw();
  } else if(t.length===1 && lastTouches.length===1 && baseLoaded){
    pan.x+=(t[0].pageX-lastTouches[0].pageX)*panSpeed;
    pan.y+=(t[0].pageY-lastTouches[0].pageY)*panSpeed;
    lastTouches=Array.from(t);
    redraw();
  }
}, {passive:false});

canvas.addEventListener('touchend', e=>{
  if(baseLoaded && lastTouches.length===1){
    const rect=canvas.getBoundingClientRect();
    const x=(lastTouches[0].pageX-rect.left-pan.x)/scale;
    const y=(lastTouches[0].pageY-rect.top-pan.y)/scale;
    const imgd=ctx.getImageData(0,0,canvas.width,canvas.height);
    floodfill(imgd.data,Math.floor(x),Math.floor(y),hexToRGBA(color),60,imgd.width,imgd.height);
    ctx.putImageData(imgd,0,0);
    pushUndo();
  }
  lastTouches=[];
}, {passive:true});

resizeCanvas();
showHome();
</script>

</body>
</html>
