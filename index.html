<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Coloring Book App</title>
  <style>
    html, body { margin:0;padding:0;height:100%;touch-action:none;font-family:'Comic Sans MS';background:#fff6e0; }
    #home,#library,#pageSelect,#drawing { display:none; flex-direction:column; align-items:center; height:100%; }
    #home { display:flex; justify-content:center; align-items:center; background:linear-gradient(to bottom right,#ffdee9,#b5fffc); }
    .home-btn { margin:20px; border:none; background:none; cursor:pointer; }
    .home-btn img { width:180px; }
    #library, #pageSelect { overflow-y:auto; padding-top:12px; }
    #pageSelect img, #library img { width:150px; margin:10px; border:3px solid #f06292; border-radius:10px; cursor:pointer; }
    #top-bar, #bottom-bar { display:flex; overflow-x:auto; gap:10px; background:#ffe0f0; padding:10px; flex-shrink:0; }
    button, .tool, .color { padding:10px; font-size:18px; border:none; border-radius:10px; cursor:pointer;
      background:#f06292; color:white; box-shadow:2px 2px 6px rgba(0,0,0,0.2); flex-shrink:0; }
    .tool, .color { width:40px; height:40px; display:flex; align-items:center; justify-content:center; }
    .color { border:2px solid #f06292; }
    .active { border:3px solid #ff4081 !important; }
    #canvas-container { position:relative; flex:1; width:100%; overflow:hidden; display:flex; justify-content:center; align-items:center; background:#fff; }
    canvas { touch-action:none; border-radius:10px; transform-origin:0 0; }
  </style>
</head>
<body>

  <!-- Home, Page Selection, Library & Drawing screens -->
  <div id="home">
    <button class="home-btn" onclick="showLibrary()"><img src="https://img.icons8.com/clouds/200/000000/opened-folder.png"/></button>
    <button class="home-btn" onclick="showPageSelect()"><img src="https://img.icons8.com/clouds/200/000000/paint-palette.png"/></button>
  </div>

  <div id="library">
    <h2>Saved</h2>
    <button onclick="showHome()">‚¨Ö Back</button>
  </div>

  <div id="pageSelect">
    <h2>Pick a Page</h2>
    <button onclick="showHome()">‚¨Ö Back</button>
  </div>

  <div id="drawing">
    <div id="top-bar">
      <button onclick="undo()">‚éå Undo</button>
      <button onclick="redo()">‚Üª Redo</button>
      <button onclick="save()">üíæ Save</button>
      <button onclick="download()">‚¨á Download</button>
      <button onclick="clearCanvas()">üóë Clear</button>
      <button onclick="showHome()">üè† Home</button>
    </div>
    <div id="canvas-container">
      <canvas id="drawCanvas" width="800" height="800"></canvas>
    </div>
    <div id="bottom-bar">
      <div class="tool" data-tool="bucket">ü™£</div>
      <div class="tool" data-tool="eraser">üßΩ</div>
    </div>
  </div>

  <audio id="clickSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_059f6bff69.mp3?filename=click-124467.mp3"></audio>

  <script>
    // ======== GLOBALS & STORAGE =========
    const STORAGE_KEY = 'myColoringLibrary';
    let savedImages = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    const canvas = document.getElementById('drawCanvas');
    const ctx = canvas.getContext('2d');
    const img = new Image(); img.crossOrigin = 'anonymous';
    const clickSound = document.getElementById('clickSound');
    let tool='bucket', color='black', scale=1, tx=0, ty=0, isDragging=false, startDrag=null, lastDist=null;
    const undoStack=[], redoStack=[];
    const drawings = [
      'https://i.postimg.cc/TPZTn08W/0f00c43f3775ba5fcce443f4885aa56e.jpg',
      'https://i.postimg.cc/JnZMxXmY/bunny-carrot-coloring-page-600nw-2414476443.jpg',
      'https://i.postimg.cc/Bv8q8yz0/36-girl-with-butterfly-wings-to-color.jpg',
      'https://i.postimg.cc/TPZTn08W/0f00c43f3775ba5fcce443f4885aa56e.jpg',
  'https://i.postimg.cc/JnZMxXmY/bunny-carrot-coloring-page-600nw-2414476443.jpg',
  'https://i.postimg.cc/Bv8q8yz0/36-girl-with-butterfly-wings-to-color.jpg',
  'https://i.postimg.cc/Bv8q8yz0/36-girl-with-butterfly-wings-to-color.jpg',
  'https://i.postimg.cc/pLsT5KXD/6331b296558cf1f8f7fd87cc9154f432.jpg',
  'https://i.postimg.cc/2yYmK5Sk/7113dc553901fe5719b2c9e221449e28.jpg',
  'https://i.postimg.cc/MKxKs9n7/adorable-fun-kids-coloring-page-delight-freepik-908673-3027.jpg',
  'https://i.postimg.cc/MKxKs9n7/adorable-fun-kids-coloring-page-delight-freepik-908673-3027.jpg',
  'https://i.postimg.cc/jS1TrcSk/Barbie-10.jpg',
  'https://i.postimg.cc/FsDmTN5v/Barbie-24.jpg',
  'https://i.postimg.cc/FsDmTN5v/Barbie-24.jpg',
  'https://i.postimg.cc/j2YdYXZr/Barbie-27.jpg',
  'https://i.postimg.cc/tTxCcfd5/Barbie-6.jpg'
      // Add more if needed...
    ];

    // ======== INITIALIZATION =========
    function init() {
      populateColors();
      buildPageSelect();
      showHome();
    }

    function buildPageSelect() {
      const ps = document.getElementById('pageSelect');
      drawings.forEach((src,i)=>{
        const imgEl = document.createElement('img');
        imgEl.src = src;
        imgEl.onclick = ()=>loadPage(i);
        ps.appendChild(imgEl);
      });
    }

    function populateColors(){
      const colorList = ['black','gray','red','orange','yellow','green','blue','purple','pink','peach','tan','brown','white','cyan','magenta','navy','#f4c2c2','#FFDAB9','#E6E6FA','#FFFACD','#FAFAD2','#FFE4E1'];
      const bb = document.getElementById('bottom-bar');
      colorList.forEach(c=>{
        const div = document.createElement('div');
        div.className='color';
        div.style.background = c;
        div.onclick = ()=>{
          clickSound.play(); color=c; updateUI();
        };
        bb.appendChild(div);
      });
      document.querySelectorAll('.tool').forEach(el=>el.onclick=()=>{
        clickSound.play(); tool=el.dataset.tool; updateUI();
      });
      updateUI();
    }

    function updateUI(){
      document.querySelectorAll('.tool').forEach(el=>el.classList.toggle('active', el.dataset.tool===tool));
      document.querySelectorAll('.color').forEach(el=>el.classList.toggle('active', el.style.background===color));
    }

    // ======== UI VIEWS ========
    function hideAll(){
      ['home','library','pageSelect','drawing'].forEach(id=>document.getElementById(id).style.display='none');
    }
    function showHome(){ hideAll(); document.getElementById('home').style.display='flex'; }
    function showLibrary(){
      hideAll(); const lib=document.getElementById('library');
      lib.style.display='flex'; lib.innerHTML='<h2>Saved</h2>';
      savedImages.forEach(src=>{
        const im=document.createElement('img');
        im.src=src;
        lib.appendChild(im);
      });
      const btn=document.createElement('button');
      btn.textContent='‚¨Ö Back'; btn.onclick=showHome;
      lib.appendChild(btn);
    }

    function showPageSelect(){ hideAll(); document.getElementById('pageSelect').style.display='flex'; }

    function loadPage(i){
      hideAll(); document.getElementById('drawing').style.display='flex';
      img.onload = ()=>{ resetTransform(); drawImageScaled(); pushUndo(); };
      img.src = drawings[i]+'?v='+Date.now();
    }

    // ======== CANVAS TRANSFORM & PAINT =======
    canvas.addEventListener('mousedown', e=>{ isDragging=true; startDrag={x:e.clientX,y:e.clientY}; });
    canvas.addEventListener('mousemove', e=>{ if(!isDragging) return; tx += e.clientX-startDrag.x; ty += e.clientY-startDrag.y; startDrag={x:e.clientX,y:e.clientY}; applyTransform(); });
    canvas.addEventListener('mouseup', ()=> isDragging=false);
    canvas.addEventListener('mouseleave', ()=> isDragging=false);
    canvas.addEventListener('click', paintAt);
    canvas.addEventListener('touchstart', e=>{
      if(e.touches.length==1){ isDragging=true; startDrag={x:e.touches[0].clientX, y:e.touches[0].clientY}; }
      if(e.touches.length==2) pinchZoom(e);
    });
    canvas.addEventListener('touchmove', e=>{ if(e.touches.length==1 && isDragging){ tx+=e.touches[0].clientX - startDrag.x; ty+=e.touches[0].clientY - startDrag.y; startDrag={x:e.touches[0].clientX,y:e.touches[0].clientY}; applyTransform(); } if(e.touches.length==2) pinchZoom(e); e.preventDefault(); });
    canvas.addEventListener('touchend', ()=>{ if(lastDist && !isDragging) lastDist=null; isDragging=false; });

    function pinchZoom(e){
      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      const dist = Math.hypot(dx,dy);
      if(lastDist){ scale *= dist/lastDist; scale = Math.min(3,Math.max(0.3,scale)); applyTransform(); }
      lastDist = dist;
    }

    function applyTransform(){
      canvas.style.transform = `translate(${tx}px,${ty}px) scale(${scale})`;
    }

    function getXY(e){
      const r = canvas.getBoundingClientRect();
      const ex = e.clientX || (e.touches && e.touches[0].clientX);
      const ey = e.clientY || (e.touches && e.touches[0].clientY);
      return {
        x: Math.floor((ex - r.left - tx)/scale),
        y: Math.floor((ey - r.top - ty)/scale)
      };
    }

    function paintAt(e){
      if(!img.src) return;
      const {x,y} = getXY(e);
      clickSound.play();
      if(tool==='bucket'){
        const data=ctx.getImageData(0,0,canvas.width,canvas.height);
        floodfill(data.data, x, y, hexToRGBA(color), 25, data.width, data.height);
        ctx.putImageData(data,0,0);
      } else {
        ctx.globalCompositeOperation='destination-out';
        ctx.beginPath(); ctx.arc(x,y,10,0,2*Math.PI); ctx.fill(); ctx.globalCompositeOperation='source-over';
      }
      pushUndo();
    }

    function floodfill(data, sx,sy, fill, tol, w,h){
      const start = (sy*w + sx)*4, base = data.slice(start,start+4);
      const match = px=>px.every((v,i)=>Math.abs(v-base[i])<tol);
      const stack=[{x:sx,y:sy}], visited=new Uint8Array(w*h);
      while(stack.length){
        const p = stack.pop(), idx = (p.y*w+p.x)*4;
        if(p.x<0||p.x>=w||p.y<0||p.y>=h||visited[p.y*w+p.x]||!match(data.slice(idx,idx+4))) continue;
        visited[p.y*w+p.x]=1;
        data[idx]=fill.r; data[idx+1]=fill.g; data[idx+2]=fill.b; data[idx+3]=fill.a;
        stack.push({x:p.x+1,y:p.y},{x:p.x-1,y:p.y},{x:p.x,y:p.y+1},{x:p.x,y:p.y-1});
      }
    }

    function hexToRGBA(hex){
      const tmp=document.createElement('div'); tmp.style.color=hex; document.body.appendChild(tmp);
      const [r,g,b]=getComputedStyle(tmp).color.match(/\d+/g).map(Number);
      document.body.removeChild(tmp); return {r,g,b,a:255};
    }

    function resetTransform(){ scale=1; tx=ty=0; applyTransform(); }
    function drawImageScaled(){
      const cw=canvas.width, ch=canvas.height, iw=img.width, ih=img.height;
      const ratio=Math.min(cw/iw, ch/ih), x=(cw-iw*ratio)/2, y=(ch-ih*ratio)/2;
      ctx.clearRect(0,0,cw,ch);
      ctx.drawImage(img,0,0,iw,ih,x,y,iw*ratio,ih*ratio);
    }

    // ======== UNDO/REDO/SAVE ========
    function pushUndo(){
      undoStack.push(canvas.toDataURL());
      if(undoStack.length>30) undoStack.shift();
      redoStack.length=0;
    }
    function undo(){ if(undoStack.length<2) return; redoStack.push(undoStack.pop()); restore(undoStack.at(-1)); }
    function redo(){ if(!redoStack.length) return; const d=redoStack.pop(); undoStack.push(d); restore(d); }
    function restore(src){ const i=new Image(); i.onload=()=>{ resetTransform(); ctx.drawImage(i,0,0); }; i.src=src; }
    function save(){
      const data = canvas.toDataURL();
      savedImages.push(data);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(savedImages));
      alert('Saved to Library!');
    }
    function download(){
      const a=document.createElement('a');
      a.href=canvas.toDataURL();
      a.download='coloring.png';
      a.click();
    }
    function clearCanvas(){ drawImageScaled(); pushUndo(); }

    // ======== START ========
    window.onload = init;
  </script>
</body>
</html>
